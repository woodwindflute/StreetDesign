<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="./dist/aframe-street-component.js"></script>
    <script src="https://unpkg.com/aframe-presentation-component/dist/aframe-presentation-component.min.js"></script>
    <script src="https://raw.githack.com/dbradleyfl/aframe-gridhelper/master/dist/aframe-gridhelper-component.min.js"></script> 

    <!-- ocean, ground, sky -->
    <script src="src/components/ocean-plane.js"></script>
    <script src="src/lib/aframe-cubemap-component.js"></script>
    <script>
      AFRAME.registerComponent('forward', {
        schema: {
          speed: {default: 0.1},
        },

        init: function() {
          var worldDirection = new THREE.Vector3();

          this.el.object3D.getWorldDirection(worldDirection);
    //          worldDirection.multiplyScalar(-1);

            this.worldDirection = worldDirection;
            console.log(this.worldDirection);
          },

          tick: function() {
            var el = this.el;

            var currentPosition = el.getAttribute('position');
            var newPosition = this.worldDirection
                              .clone()
                              .multiplyScalar(this.data.speed)
                              .add(currentPosition);
            el.setAttribute('position', newPosition);
          }
        });
      </script>
      <script>
        AFRAME.registerComponent('timed-inspector', {
          init: function() {
            this.data // seconds
            setTimeout( function () {
              window.postMessage('INJECT_AFRAME_INSPECTOR')
            }, this.data * 1000)
          }
        });
      </script>
      <script>
        const settings = JSON.parse(localStorage.getItem("settings"));
        const creator = settings.lastStreetCreatorId;
        const streetId = settings.lastStreetNamespacedId;
        let streetmixAPIURL =
          creator != undefined
            ? "https://" + location.host + "/" + creator + "/" + streetId
            : "https://" + location.host + "/-/" + streetId;
        console.log(streetmixAPIURL);
      </script>
    <style>
      .rs-base {
        left: 20px;
        top: 80px;
      }

      body {
        background-color: gray;
      }

      div#aframe-presentation-progress-bar {
        background-color: rgb(201, 0, 201) !important;
      }
    </style>

  </head>
  <body>
    <a-scene 
    renderer="colorManagement: true; highRefreshRate: true; foveationLevel: 3; physicallyCorrectLights: true; logarithmicDepthBuffer: false;"
    fogoff="type: linear; color: #D5C69B; far: 200"
    gltf-model="dracoDecoderPath: https://www.gstatic.com/draco/v1/decoders/;"
    gridhelper="size:1000;divisions:50;colorGrid:#c900c9;colorCenterLine:#c900c9;"
    background="color: black"
    >
      <a-assets>
        <streetmix-assets url="./"></streetmix-assets>

        <a-cubemap id="skycube">
          <img src="assets/images/skybox/posx.jpg">
          <img src="assets/images/skybox/negx.jpg">
          <img src="assets/images/skybox/posy.jpg">
          <img src="assets/images/skybox/negy.jpg">
          <img src="assets/images/skybox/posz.jpg">
          <img src="assets/images/skybox/negz.jpg">
        </a-cubemap>

      </a-assets>
      <a-presentation disable-aspect-ratio="16:9" use-hash="false">
        <a-slide>
          <a-slide-camera position="0 500 0" rotation="-90 0 90"></a-slide-camera>
          <a-slide-visibility selector="#labelParent1" visibility="true"></a-slide-visibility>
        </a-slide>
        <a-slide>
          <a-slide-animation selector="#camera" animations="zoomout"></a-slide-animation>
          <a-slide-camera position="0 30 0" rotation="-90 0 0" duration="100"></a-slide-camera>
          <a-slide-visibility selector="#labelParent2" visibility="true"></a-slide-visibility>

        </a-slide>
        <a-slide>
          <a-slide-camera position="0 10 25" rotation="-30 0 0" ></a-slide-camera>
        </a-slide>
        <a-slide>
          <a-slide-camera position="0 0 500" rotation="0 0 0" duration="100"></a-slide-camera>
          <a-slide-animation selector="#camera" animations="zoominfast"></a-slide-animation>

        </a-slide>
      </a-presentation>
      <a-entity id="cameraRig" position="0 0 0">
        <a-entity id="camera" camera="far: 1000; zoom: 20" wasd-controls="enabled: false" 
        animation__zoomin="property: camera.zoom; from: 1; to: 22; dur: 7000; easing: easeInOutQuad; "
        animation__zoominfast="property: camera.zoom; from: 1; to: 40; dur: 100; easing: linear; autoplay: false;"
        animation__zoomout="property: camera.zoom; from: 22; to: 1; dur: 100; easing: linear; autoplay: false;"
        ></a-entity>
        <a-entity id="leftHand" hand-controls="hand: left; handModelStyle: lowPoly; color: #ccffcc" teleport-controls="cameraRig: #cameraRig; button: trigger"></a-entity>
        <a-entity id="rightHand" hand-controls="hand: right; handModelStyle: lowPoly; color: #ccffcc" teleport-controls="cameraRig: #cameraRig; button: trigger"></a-entity>
      </a-entity>

      <a-entity light="type: ambient; color: #FFF; intensity: 2"></a-entity>
      <a-entity light="type: directional; color: #FFF; intensity: 0.6; castShadow:true;" position="0.5 1 -1"></a-entity>

      <a-ocean-plane visible="false" height="100" width="100" position="0 -10 0" material="envMap: #skycube;"></a-ocean-plane>

      <a-entity id="skybox" cubemap="folder: assets/images/skybox/"
      animation="property: visible; from: false; to: true; dur: 3000;"
      ></a-entity>

      <a-entity id="street-parent" street streetmix-loader></a-entity>

    </a-scene>
  </body>
  <script>
    let street = document.getElementById("street-parent");
    console.log(street);
    street.setAttribute(
      "streetmix-loader",
      "streetmixStreetURL: " + streetmixAPIURL
    );
    console.log(street);
  </script>
</html>
